<h2>Missing Timesheet Requests</h2>
<div class="form-row">
  <div class="col-6">{{pluralize timesheetMissing.length 'missing entry request'}}</div>
  <div class="col-6 text-right"><button class="btn btn-secondary btn-sm ml-auto" {{action "newEntryAction"}}>New Request</button></div>
</div>
<table class="table table-striped table-sm">
  <thead>
    <tr>
      <th>&nbsp;</th>
      <th>From</th>
      <th>To</th>
      <th class="text-right">Time</th>
      <th class="text-right">Credits</th>
      <th>Position</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {{#each timesheetMissing as |tm|}}
    <tr>
      <td>&nbsp;</td>
      <td>{{shift-format tm.on_duty}}</td>
      <td>{{shift-format tm.off_duty}}</td>
      <td class="text-right">{{hour-minute-format tm.duration}}</td>
      <td class="text-right">{{credits-format tm.credits}}</td>
      <td>{{tm.position.title}}</td>
      <td>
        <button class="btn btn-primary btn-sm" {{action "editTimesheetAction" tm}}>Manage</button>
        <button class="btn btn-secondary btn-sm" {{action "removeTimesheetAction" tm}}>{{fa-icon "trash"}}</button>
      </td>
    </tr>
    {{/each}}
  </tbody>
</table>

{{#if newEntry}}
{{#ch-form "entry" newEntry modalBox=true modalTitle="Create New Missing Timesheet Request" validator=newEntryValidations onSubmit=(action "createEntryAction") onCancel=(action "cancelNewEntryAction") as |f|}}
  <div class="form-row">
    {{f.input 'on_duty' type="datetime" label="On Duty"}}
    {{f.input 'off_duty' type="datetime" label="Off Duty"}}
    {{f.input 'position_id' type="select" options=positions label="Position"}}
  </div>
  <div class="form-row">
    {{f.input 'partner' type="text" label="Partner(s) for shift." size=40 maxlength=60 }}
  </div>
  <div class="form-row">
    {{f.input 'notes' type="textarea" cols=80 rows=4 options=positions label="Correction Notes"}}
  </div>
  {{f.submit}}
  {{f.cancel}}
{{/ch-form}}
{{/if}}

{{#if editTimesheet}}
{{#ch-form "entry" editTimesheet modalBox=true modalTitle=(concat "Manage Missing Timesheet Request ID #" editTimesheet.id) validator=timesheetValidations onSubmit=(action "saveTimesheetAction") onCancel=(action "cancelTimesheetAction") as |f|}}
  <dl class="form-row">
    <dt class="col-2">Position:</dt>
    <dd class="col-10">{{editTimesheet.position.title}}</dd>

    <dt class="col-2">Time:</dt>
    <dd class="col-10">{{shift-format editTimesheet.on_duty}} - {{shift-format editTimesheet.off_duty}}</dd>

    <dt class="col-2">Duration:</dt>
    <dd class="col-10">{{hour-minute-format editTimesheet.duration}}</dd>

    <dt class="col-2">Credits:</dt>
    <dd class="col-10">{{credits-format editTimesheet.credits}}</dd>

    <dt class="col-2">Note:</dt>
    <dd class="col-10">{{editTimesheet.notes}}</dd>

    <dt class="col-2">Partner(s):</dt>
    <dd class="col-10">
      {{#if (and editTimesheet.partner editTimesheet.partner_info)}}
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>Partner</th>
              <th>From</th>
              <th>To</th>
              <th>Position</th>
              <th>Timesheet</th>
            </tr>
          </thead>
          <tbody>
            {{#each partnerInfo as |pi|}}
            <tr>
              <td>{{pi.callsign}}</td>

            {{#if pi.on_duty}}
              <td>{{shift-format pi.on_duty}}</td>
              <td>{{shift-format pi.off_duty}}</td>
              <td>{{pi.position_title}}</td>
            {{else if pi.person_id}}
              <td colspan="3" class="text-danger">no shift within 30 mins of {{shift-format editTimesheet.on_duty}}</td>
            {{else}}
              <td colspan="4" class="text-danger">callsign not found</td>
            {{/if}}
            {{#if pi.person_id}}
              <td>
                <button class="btn btn-secondary btn-sm" {{action "viewPartnerTimesheetAction" pi}}>
                  View
                </button>
              </td>
              {{/if}}
            </tr>
           {{/each}}
          </tbody>
        </table>
      {{else}}
        <i>No partner name given</i>
      {{/if}}
    </dd>
  </dl>

  <fieldset>
    <legend>Submission Review</legend>
    {{#if editTimesheet.reviewed_at}}
    <div class="form-row">
      Last review on {{shift-format editTimesheet.reviewed_at}} by {{editTimesheet.reviewer_person.callsign}}
    </div>
    {{/if}}
    <div class="form-row">
      {{f.input "reviewer_notes"
        label="Enter your response to the person below. Be clear and concise."
        type="textarea" cols=80 rows=4
      }}
    </div>
    <div class="form-group row">
        <div class="col-auto">Correction Status:</div>
        <div class="col-auto">
          {{f.input "review_status" label="Review Status" type="radioGroup" options=reviewOptions inline=true onChange=(action "statusChangeAction")}}
        </div>
    </div>
</fieldset>
  {{#if (eq f.model.review_status "approved")}}
  <fieldset>
    <legend>New Timesheet Entry</legend>
    <div class="form-row">
      <div class="form-group">
        {{f.input 'create_entry' type="checkbox" label="Create new entry" }}
      </div>
    </div>
    <div class="form-row">
      {{f.input 'new_on_duty' type="datetime" label="On Duty"}}
      {{f.input 'new_off_duty' type="datetime" label="Off Duty"}}
      {{f.input 'new_position_id' type="select" options=positions label="Position"}}
    </div>
  </fieldset>
  {{/if}}
  {{f.submit}}
  {{f.cancel}}
  {{#if partnerTimesheet}}
  <hr>
  <table class="table table-sm">
    <caption>{{partnerCallsign}} {{year}} Timesheet</caption>
    <thead>
      <tr>
        <th>From</th>
        <th>To</th>
        <th>Duration</th>
        <th>Position</th>
      </tr>
    </thead>

    <tbody>
    {{#each partnerTimesheet as |pt| }}
    <tr>
      <td>{{shift-format pt.on_duty}}</td>
      {{#if pt.off_duty}}
        <td>
            {{shift-format pt.off_duty}}
        </td>
        <td>
          {{hour-minute-format pt.duration}}
        </td>
      {{else}}
        <td colspan="2">On Duty</td>
      {{/if}}
      <td>{{pt.position.title}}</td>
    </tr>
    {{/each}}
    </tbody>
  </table>
  {{/if}}
{{/ch-form}}
{{/if}}
